<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guestbook</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
  <link rel=icon href=favicon.png>
  <style>
    :root, body {
      margin: 0;
      width: 100%;
      min-height: 100%;
      font-family: "Press Start 2P", system-ui;
    }
    body {
      background: #000;
      color: #00ffff;
    }
    .logo {
      display: block;
      margin: 5% auto;
      padding: 0;
      box-sizing: border-box;
      border-radius: 5px;
      padding-left: 0.2em;
      font-size: 8rem;
      width: 12rem;
      height: 12rem;
      line-height: 13rem;
      text-align: center;
      position: relative;
      background: #84d;
      animation: rotate 4s linear infinite;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @media (max-width: 640px) {
      .logo {
        font-size: 4rem;
        width: 6rem;
        height: 6rem;
        line-height: 6.5rem;
      }
    }
    input, textarea, button {
      font-family: "Press Start 2P", system-ui;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen">
  <!-- Header with Logo -->
  <header class="w-full flex justify-center py-8">
    <div class="logo">></div>
  </header>

  <!-- Main Content -->
  <main class="max-w-2xl mx-auto px-4 text-center">
    <h1 class="text-2xl md:text-3xl text-[#00ffff] mb-6">Guestbook</h1>
    <p class="text-sm md:text-base text-[#00ffff] mb-8">
      Leave a message, join the indie web vibe!
    </p>

    <!-- Form -->
    <form id="guestbook-form" class="space-y-4 mb-8">
      <div>
        <input type="text" id="username" placeholder="Username" required
          class="bg-[#222] text-[#00ffff] p-2 rounded w-full text-sm" aria-label="Username">
      </div>
      <div>
        <input type="password" id="password" placeholder="Password" required
          class="bg-[#222] text-[#00ffff] p-2 rounded w-full text-sm" aria-label="Password">
      </div>
      <div>
        <input type="text" id="name" placeholder="Your Name" required
          class="bg-[#222] text-[#00ffff] p-2 rounded w-full text-sm" aria-label="Name">
      </div>
      <div>
        <textarea id="message" placeholder="Your Message" required
          class="bg-[#222] text-[#00ffff] p-2 rounded w-full text-sm h-24" aria-label="Message"></textarea>
      </div>
      <button type="submit" id="submit-btn"
        class="bg-[#84d] text-[#00ffff] px-6 py-3 text-sm rounded hover:bg-[#a6f] transition disabled:opacity-50">
        Submit
      </button>
    </form>
    <p id="status" class="text-sm text-[#00ffff] hidden"></p>

    <!-- Messages -->
    <section id="messages" class="text-left space-y-4">
      <h2 class="text-lg text-[#00ffff] mb-4">Messages</h2>
      <div id="message-list"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="w-full py-8 text-center text-sm text-[#00ffff]">
    <p>Built with love for the indie web. Â© 2025</p>
  </footer>

  <!-- Favicon Generation Script -->
  <script>
    const downloadable = false;
    const canvas = document.createElement('canvas');
    canvas.width = 512;
    canvas.height = 512;
    const ctx = canvas.getContext('2d');
    const cornerRadius = 5;
    ctx.beginPath();
    ctx.roundRect(0, 0, 512, 512, cornerRadius);
    ctx.clip();
    ctx.fillStyle = '#00ffff';
    ctx.font = '384px "Press Start 2P"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('>', 307.2, 272);
    const dataUrl = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = 'favicon.png';
    link.innerText = 'icon.png';
    if (downloadable) {
      link.click();
      document.body.appendChild(link);
    }
  </script>

  <!-- Guestbook Logic -->
  <script>
    // GitHub configuration (replace with your details)
    const GITHUB_OWNER = 'YOUR_USERNAME';
    const GITHUB_REPO = 'YOUR_REPO';
    const WORKFLOW_ID = 'backend.yml';
    const GITHUB_TOKEN = 'YOUR_PERSONAL_ACCESS_TOKEN'; // Secure in production

    // Initialize SQLite
    async function initDB() {
      try {
        const response = await fetch('/data.db');
        if (!response.ok) throw new Error('Failed to fetch data.db');
        const buffer = await response.arrayBuffer();
        const SQL = await initSqlJs({ locateFile: () => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.wasm' });
        return new SQL.Database(new Uint8Array(buffer));
      } catch (error) {
        console.error('Error initializing DB:', error);
        throw error;
      }
    }

    // Load and display messages
    async function loadMessages() {
      const messageList = document.getElementById('message-list');
      try {
        const db = await initDB();
        const results = db.exec('SELECT name, message FROM messages ORDER BY id DESC');
        messageList.innerHTML = '';
        if (results[0]) {
          results[0].values.forEach(([name, message]) => {
            const div = document.createElement('div');
            div.className = 'bg-[#222] p-4 rounded';
            div.innerHTML = `<p class="text-sm"><strong>${escapeHTML(name)}</strong>: ${escapeHTML(message)}</p>`;
            messageList.appendChild(div);
          });
        } else {
          messageList.innerHTML = '<p class="text-sm text-[#00ffff]">No messages yet.</p>';
        }
        db.close();
      } catch (error) {
        messageList.innerHTML = '<p class="text-sm text-[#ff5555]">Error loading messages.</p>';
      }
    }

    // Escape HTML to prevent XSS
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
    }

    // Handle form submission
    document.getElementById('guestbook-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submit-btn');
      const status = document.getElementById('status');
      submitBtn.disabled = true;
      status.classList.remove('hidden');
      status.textContent = 'Saving...';
      status.className = 'text-sm text-[#00ffff]';

      const payload = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        name: document.getElementById('name').value,
        message: document.getElementById('message').value
      };

      try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/${WORKFLOW_ID}/dispatches`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ref: 'main',
            inputs: { payload: JSON.stringify(payload) }
          })
        });

        if (!response.ok) throw new Error('Failed to trigger workflow');

        // Poll for Pages redeploy (simplified; adjust interval/duration as needed)
        await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10s
        status.textContent = 'Message saved!';
        status.className = 'text-sm text-[#00ff00]';
        document.getElementById('guestbook-form').reset();
        await loadMessages();
      } catch (error) {
        console.error('Error:', error);
        status.textContent = 'Error saving message.';
        status.className = 'text-sm text-[#ff5555]';
      } finally {
        submitBtn.disabled = false;
        setTimeout(() => status.classList.add('hidden'), 3000);
      }
    });

    // Load messages on page load
    loadMessages();
  </script>
</body>
</html>
